<partial id="title">CALENDAR VIEW</partial>

<partial id="content">
    <div id="toolbar" class="toolbar clear">
        <ul class="tools">
            <li class="tool-item">
                <div id="viewFilter" style="margin-top:8px;"></div>
            </li>
            <li class="tool-item">
                <span id="calendarTitle" class="font-highlight" style="font-size:16px;line-height:40px;"></span>
            </li>
        </ul>
        <ul class="tools" style="float:right">
            <li class="tool-item action-buttons">
                <a id="previous" class="tool-action-button" href="javascript:void(0)" title="后退">
                    <i class="fa fa-chevron-left"></i>
                </a>
                <a id="today" class="tool-action-button" href="javascript:void(0)" title="今日">
                    <span>今</span>
                </a>
                <a id="next" class="tool-action-button" href="javascript:void(0)" title="前进">
                    <i class="fa fa-chevron-right"></i>
                </a>
            </li>
        </ul>
        <div class="toolbar-extend">
            <ul class="tools">
                <li class="tool-item">
                    <div class="top-container">
                        <button id="yearSchedule" class="tool-button button-highlight" style="width:70px">显示角标</button>
                        <button id="yearRemoveSchedule" class="tool-button" style="width:70px">移除周六</button>
                        <br />
                        <button id="yearSelect" class="tool-button" style="width:70px">选择周末</button>
                        <button id="yearGet" class="tool-button" style="width:70px">获取选项</button>
                        <br />
                        <button id="yearCancel" class="tool-button" style="width:70px">取消选择</button>
                    </div>
                    <div class="bottom-title">
                        <span>年视图</span>
                    </div>
                </li>
                <li class="tool-item">
                    <hr class="extend-spliter" />
                </li>
                <li class="tool-item">
                    <div class="top-container">
                        <button id="monthSchedule" class="tool-button button-highlight" style="width:70px">显示日程</button>
                        <button id="monthRemoveSchedule" class="tool-button" style="width:70px">移除日程</button>
                        <br />
                        <button id="monthSelect" class="tool-button" style="width:70px">选择周末</button>
                        <button id="monthGet" class="tool-button" style="width:70px">获取选项</button>
                        <br />
                        <button id="monthCancel" class="tool-button" style="width:70px">取消选择</button>
                    </div>
                    <div class="bottom-title">
                        <span>月视图</span>
                    </div>
                </li>
                <li class="tool-item">
                    <hr class="extend-spliter" />
                </li>
                <li class="tool-item">
                    <div class="top-container"></div>
                    <div class="bottom-title">
                        <span>周视图</span>
                    </div>
                </li>
                <li class="tool-item">
                    <hr class="extend-spliter" />
                </li>
                <li class="tool-item">
                    <div class="top-container"></div>
                    <div class="bottom-title">
                        <span>日视图</span>
                    </div>
                </li>
                <li class="tool-item">
                    <hr class="extend-spliter" />
                </li>
            </ul>
        </div>
    </div>
    <div id="calendarView"></div>
</partial>

<partial id="style">
    <style type="text/css">
        .filter-tools-item-text {
            margin-left: 20px;
            margin-right: 20px;
        }

        .toolbar .toolbar-extend .extend-spliter {
            margin-top: 8px;
            height: 104px;
        }

        .toolbar .top-container {
            width: 150px;
            height: 96px;
            line-height: 30px;
        }

            .toolbar .top-container .tool-button {
                line-height: 20px;
                vertical-align: top;
                margin-top: 6px;
            }

        .toolbar .bottom-title {
            width: 100%;
            text-align: center;
            height: 24px;
            line-height: 24px;
            font-size: 12px;
        }
    </style>
</partial>

<partial id="script">
    <script type="text/javascript">
        (function() {
            window.pageLogic = {
                init: {
                    before: function() {
                        this.toolbar = ui.master.createToolbar("toolbar");
                        // 创建日历视图
                        this.calendarView = $("#calendarView").calendarView({
                            // 默认显示年视图
                            defaultView: "YearView",
                            // 星期天是一个周的第一天
                            sundayFirst: true,
                            // 年视图可以多选
                            yearMultipleSelect: true,
                            // 月视图可以多选
                            monthMultipleSelect: true
                        });
                        this.calendarView.viewChanged(function(e, view) {
                            $("#calendarTitle").text(view.getTitle());
                        });
                        this.calendarView.changed(function(e, view) {
                            $("#calendarTitle").text(view.getTitle());
                            if(this.isView(view, "YearView")) {
                                if(pageLogic.yearSchedule) {
                                    loadYearSchedule(view);
                                }
                            } else if(this.isView(view, "MonthView")) {
                                if(pageLogic.monthSchedule) {
                                    loadMonthSchedule(view);
                                }
                                //view.addSchedules(loadMonthSchedule(), "date");
                            } else if(this.isView(view, "WeekView")) {
                                // view.addSchedules(loadWeekSchedule(), "BeginTime", "EndTime", function(item, container) {
                                //     container.html("<p class='schedule-content-text'>" + item.data.Text + "</p>");
                                // });
                            } else if (this.isView(view, "DayView")) {
                                // view.addSchedules(loadWeekSchedule(), "BeginTime", "EndTime", function(item, container) {
                                //     container.html("<p class='schedule-content-text'>" + item.data.Text + "</p>");
                                // });
                            }
                        });
                    },
                    layout: function() {
                        // 注册resize事件
                        ui.master.resize(function(e) {
                            var width, 
                                height,
                                calendarViewHeight;
                            
                            // 有master自动计算的内容区域的宽度和高度
                            width = ui.master.contentBodyWidth;
                            height = ui.master.contentBodyHeight;

                            calendarViewHeight = height - pageLogic.toolbar.height;
                            pageLogic.calendarView.setSize(width, calendarViewHeight);
                        });
                    },
                    after: function() {
                        // 创建过滤器对象
                        this.viewFilter = $("#viewFilter").filterTool({
                            viewData: [
                                { text: "年", value: "YearView", selected: true },
                                { text: "月", value: "MonthView" },
                                { text: "周", value: "WeekView" },
                                { text: "日", value: "DayView" }
                            ]
                        });
                        this.viewFilter.selected(function(e, item) {
                            pageLogic.calendarView.changeView(item.value);
                        });
                        $("#calendarTitle").text(pageLogic.calendarView.getTitle());
                    },
                    events: function() {
                        // 视图内容切换
                        $("#previous").click(function(e) {
                            pageLogic.calendarView.previous();
                        });
                        $("#today").click(function(e) {
                            pageLogic.calendarView.today();
                        });
                        $("#next").click(function(e) {
                            pageLogic.calendarView.next();
                        });
                        
                        bindYearEvents();
                        bindMonthEvents();
                    },
                    load: function() {

                    }
                }
            };

            // 年视图相关方法
            function bindYearEvents() {
                var getViewFn = function() {
                    var view = pageLogic.calendarView.currentView;
                    if(!pageLogic.calendarView.isView(view, "YearView")) {
                        ui.messageShow("请先切换到年视图");
                        return;
                    }
                    return view;
                };
                $("#yearSchedule").click(function(e) {
                    var elem = $(e.target),
                        view = getViewFn();
                    if(view) {
                        if(!elem.hasClass("background-highlight")) {
                            elem.addClass("background-highlight");
                            pageLogic.yearSchedule = true;
                            loadYearSchedule(view);
                        } else {
                            elem.removeClass("background-highlight");
                            pageLogic.yearSchedule = true;
                            view.clearSchedules();
                        }
                    }
                });
                $("#yearRemoveSchedule").click(function(e) {
                    var view = getViewFn(),
                        selectionData;
                    if(view && pageLogic.yearSchedule) {
                        removeSaturdaySchedule(view);
                    }
                });
                $("#yearSelect").click(function(e) {
                    var view = getViewFn();
                    if(view) {
                        selectWeekendWithYear(view);
                    }
                });
                $("#yearGet").click(function(e) {
                    var view = getViewFn(),
                        selectionData;
                    if(view) {
                        selectionData = getSelectionWeekend(view);
                        if(selectionData.length > 0) {
                            alert(selectionData);
                        } else {
                            ui.messageShow("没有选择的日期");
                        }
                    }
                });
                $("#yearCancel").click(function(e) {
                    var view = getViewFn();
                    if(view) {
                        view.cancelSelection();
                    }
                });
            }
            function loadYearSchedule(view) {
                var data = [],
                    year = view.year,
                    i, j, d;
                for(var i = 0; i < 12; i++) {
                    d = new Date(year, i + 1, 0);
                    for(j = 1; j < d.getDate(); j++) {
                        if(ui.random.getNum(1, 10) > 5) {
                            continue;
                        }
                        data.push(new Date(year, i, j));
                    }
                }

                view.addSchedules(data, "date", function(item) {
                    this.prop("title", ui.str.dateFormat(item, "yyyy-MM-dd"));
                });
            }
            function removeSaturdaySchedule(view) {
                var year = view.year,
                    date = new Date(year, 0, 1),
                    data = [];
                date.setDate(date.getDate() + 6 - date.getDay());
                while(date.getFullYear() === year) {
                    data.push(new Date(date.getTime()));
                    date.setDate(date.getDate() + 7);
                }
                view.removeSchedules(data, "date", function(item) {
                    this.removeAttr("title");
                });
            }
            function selectWeekendWithYear(view) {
                var year = view.year,
                    date = new Date(year, 0, 1),
                    data = [];
                date.setDate(date.getDate() + 6 - date.getDay());
                while(date.getFullYear() === year) {
                    data.push(new Date(date.getTime()));
                    if(date.getMonth() != 11 && date.getDate() != 31) {
                        data.push(new Date(date.getFullYear(), date.getMonth(), date.getDate() + 1));
                    }

                    date.setDate(date.getDate() + 7);
                }
                view.setSelection(data);
            }
            function getSelectionWeekend(view) {
                var data = view.getSelection(),
                    i, len;
                for(i = 0, len = data.length; i < len; i++) {
                    data[i] = ui.str.dateFormat(data[i], "yyyy-MM-dd");
                }
                return data;
            }
            

            // 月视图相关方法
            function bindMonthEvents() {
                var getViewFn = function() {
                    var view = pageLogic.calendarView.currentView;
                    if(!pageLogic.calendarView.isView(view, "MonthView")) {
                        ui.messageShow("请先切换到月视图");
                        return;
                    }
                    return view;
                };
                $("#monthSchedule").click(function(e) {
                    var elem = $(e.target),
                        view = getViewFn();
                    if(view) {
                        if(!elem.hasClass("background-highlight")) {
                            elem.addClass("background-highlight");
                            pageLogic.monthSchedule = true;
                            loadMonthSchedule(view);
                        } else {
                            elem.removeClass("background-highlight");
                            pageLogic.monthSchedule = true;
                            view.clearSchedules();
                        }
                    }
                });
                $("#monthRemoveSchedule").click(function(e) {
                    var view = getViewFn(),
                        selectionData;
                    if(view) {
                    }
                });
                $("#monthSelect").click(function(e) {
                    var view = getViewFn();
                    if(view) {
                    }
                });
                $("#monthGet").click(function(e) {
                    var view = getViewFn(),
                        selectionData;
                    if(view) {
                        selectionData = [];
                        if(selectionData.length > 0) {
                            alert(selectionData);
                        } else {
                            ui.messageShow("没有选择的日期");
                        }
                    }
                });
                $("#monthCancel").click(function(e) {
                    var view = getViewFn();
                    if(view) {
                        view.cancelSelection();
                    }
                });
            }
            function loadMonthSchedule(view) {
                var count = ui.random.getNum(20, 100),
                    data = [],
                    today = new Date(),
                    textArray = ["会议", "看电影", "晚餐", "学习插花", "锻炼身体", "Coding", "玩游戏", "干家务"];
                for(var i = 0; i < count; i++) {
                    data[i] = {
                        date: new Date(
                            today.getFullYear(), 
                            today.getMonth(), 
                            ui.random.getNum(1, 28), 
                            ui.random.getNum(0, 24), 
                            ui.random.getNum(0, 60), 
                            0),
                        text: "",
                        color: ui.theme.Colors[ui.random.getNum(0, ui.theme.Colors.length)].Color
                    };
                    data[i].text = ui.str.dateFormat(data[i].date, "HH:mm") 
                        + " " 
                        + textArray[ui.random.getNum(0, textArray.length)];
                }
                view.addSchedules(data, "date", function(item) {
                    var scheduleList,
                        items,
                        container,
                        builder,
                        baseColor = ui.theme.backgroundColor || "#FFFFFF",
                        bgcolor;

                    bgcolor = ui.color.overlay(item.color, baseColor, .7);
                    bgcolor = ui.color.rgb2hex(bgcolor.red, bgcolor.green, bgcolor.blue);
                    
                    container = this.children(".day-container");
                    scheduleList = container.children(".schedule-list");
                    
                    if(scheduleList.length === 0) {
                        scheduleList = $("<ul class='schedule-list' />");
                        scheduleList.data("schedule-items", []);
                        container.append(scheduleList);
                    }

                    items = scheduleList.data("schedule-items");
                    items.push(item);

                    builder = [];
                    builder.push("<li class='schedule-item' style='color:#666;background-color:", bgcolor, "'>");
                    builder.push("<b class='schedule-border' style='background-color:", item.color, "'></b>");
                    builder.push("<span class='schedule-text'>", item.text, "</span>");
                    builder.push("</li>");
                    scheduleList.append(builder.join(""));
                });
            }

            // 周视图相关方法

            // 日视图相关方法
        })();
    </script>
</partial>
